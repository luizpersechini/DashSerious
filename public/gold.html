<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Gold (XAU) Detail</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body>
    <div class="appbar">
      <a class="back" href="/">← Back</a>
      <div class="brand">Gold (XAU) Detail</div>
      <div style="margin-left:auto; display:flex; align-items:center; gap:12px;">
        <span class="badge">Last update: <span id="lastUpdated">—</span></span>
      </div>
    </div>
    <main class="container">
      <div class="card metal-gold detail-half">
        <div class="title">Gold</div>
        <div class="value price" id="spot">—</div>
        <div class="controls">
          <label class="muted" style="margin-right:auto">Chart</label>
          <select id="tf">
            <option value="360" selected>1y</option>
            <option value="1080">3y</option>
            <option value="1800">5y</option>
          </select>
          <select id="per">
            <option value="daily" selected>Daily</option>
            <option value="weekly">Weekly</option>
            <option value="monthly">Monthly</option>
          </select>
        </div>
        <svg id="chart" class="chart" viewBox="0 0 100 28" preserveAspectRatio="none"></svg>
      </div>
    </main>

    <script>
      async function loadSpot() {
        const res = await fetch('/api/gold/latest');
        const data = await res.json();
        if (!data.success) return;
        const d = data.data;
        document.getElementById('spot').innerHTML = `${new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 2 }).format(d.usdPerOunce)} <span class="unit">USD/oz</span>`;
        document.getElementById('lastUpdated').textContent = new Date(d.timestamp).toLocaleString();
      }

      function startOfDay(ts){ const d=new Date(ts); d.setHours(0,0,0,0); return d.getTime(); }
      function startOfWeek(ts){ const d=new Date(startOfDay(ts)); const day=d.getDay(); const diff=(day+6)%7; d.setDate(d.getDate()-diff); return d.getTime(); }
      function startOfMonth(ts){ const d=new Date(startOfDay(ts)); d.setDate(1); return d.getTime(); }

      function aggregate(points, periodicity){
        if (periodicity==='weekly'){
          const map=new Map();
          for(const p of points){ const k=startOfWeek(p.t); const arr=map.get(k)||[]; arr.push(p.v); map.set(k,arr); }
          return Array.from(map.entries()).sort((a,b)=>a[0]-b[0]).map(([t,arr])=>({t:Number(t), v:arr.reduce((s,x)=>s+x,0)/arr.length}));
        }
        if (periodicity==='monthly'){
          const map=new Map();
          for(const p of points){ const k=startOfMonth(p.t); const arr=map.get(k)||[]; arr.push(p.v); map.set(k,arr); }
          return Array.from(map.entries()).sort((a,b)=>a[0]-b[0]).map(([t,arr])=>({t:Number(t), v:arr.reduce((s,x)=>s+x,0)/arr.length}));
        }
        return points;
      }

      function render(svg, points){
        if (!points||points.length<2){ svg.innerHTML=''; return; }
        const W=100,H=28,PL=12,PR=2,PT=2,PB=10;
        const rawMinV=Math.min(...points.map(p=>p.v)); const rawMaxV=Math.max(...points.map(p=>p.v));
        const base=100; const segments=6;
        const minV=Math.floor(rawMinV/base)*base;
        const maxCandidate=Math.ceil(rawMaxV/base)*base;
        const step=Math.max(base, Math.ceil(((maxCandidate-minV)/segments)/base)*base);
        const maxV=minV + step*segments;
        const spanV=maxV-minV||1;
        const minT=points[0].t; const maxT=points[points.length-1].t; const spanT=Math.max(1,maxT-minT);
        const toX=t=>PL+((t-minT)/spanT)*(W-PL-PR);
        const toY=v=>H-PB-((v-minV)/spanV)*(H-PT-PB);
        const pts=points.map(p=>`${toX(p.t)},${toY(p.v)}`).join(' ');
        let xTicks='';
        const maxTicks=6; const s=new Date(minT); s.setDate(1); s.setHours(0,0,0,0); const e=new Date(maxT); e.setDate(1); e.setHours(0,0,0,0);
        const monthStarts=[]; const di=new Date(s.getTime());
        while(di<=e){ monthStarts.push(new Date(di.getTime()).getTime()); di.setMonth(di.getMonth()+1); }
        const stride=Math.max(1, Math.ceil(monthStarts.length/maxTicks));
        const longRange=(maxT-minT)>365*24*60*60*1000;
        monthStarts.filter((_,i)=>i%stride===0).forEach(ts=>{ const x=toX(ts); const d=new Date(ts); const label=longRange? d.toLocaleDateString(undefined,{month:'short',year:'2-digit'}): d.toLocaleDateString(undefined,{month:'short'}); xTicks+=`<line x1="${x}" y1="${H-PB}" x2="${x}" y2="${H-PB+1}" class="axis" />`+`<text x="${x}" y="${H-1}" text-anchor="middle" class="axis">${label}</text>`; });
        let yTicks='';
        const nf = new Intl.NumberFormat('en-US', { maximumFractionDigits: 0 });
        // Major ticks and labels
        for(let j=0;j<=segments;j++){
          const v=minV + j*step; const y=toY(v);
          yTicks+=`<line x1="${PL-1}" y1="${y}" x2="${PL}" y2="${y}" class="axis" />`;
          const lbl = nf.format(v);
          yTicks+=`<text x="${PL-0.2}" y="${y-0.5}" text-anchor="end" class="axis yaxis">${lbl}</text>`;
        }
        // Minor half-step ticks (no labels)
        for(let j=1;j<segments*2;j+=2){
          const v=minV + (j*step)/2; const y=toY(v);
          yTicks+=`<line x1="${PL-0.8}" y1="${y}" x2="${PL}" y2="${y}" class="minor" />`;
        }
        svg.innerHTML=`<g class="grid"><line x1="${PL}" y1="${H-PB}" x2="${W-PR}" y2="${H-PB}" /></g><g class="axis">${xTicks}${yTicks}</g><polyline points="${pts}" fill="none" stroke="url(#g)" stroke-width="0.4" /><defs><linearGradient id="g" x1="0" x2="1" y1="0" y2="0"><stop offset="0%" stop-color="var(--accent-a)" /><stop offset="50%" stop-color="var(--accent-b)" /><stop offset="100%" stop-color="var(--accent-c)" /></linearGradient></defs>`;
      }

      async function loadChart(){
        const days=Number((document.getElementById('tf')).value)||360;
        const per=(document.getElementById('per')).value;
        const res=await fetch(`/api/gold/timeseries?limit=${days+5}`); const js=await res.json(); if(!js.success) return;
        let pts=js.data.points.sort((a,b)=>a.t-b.t).slice(-days);
        pts=aggregate(pts, per);
        render(document.getElementById('chart'), pts);
      }

      (function init(){
        loadSpot(); loadChart();
        document.getElementById('tf').addEventListener('change', loadChart);
        document.getElementById('per').addEventListener('change', loadChart);
      })();

      
    </script>
  </body>
  </html>


